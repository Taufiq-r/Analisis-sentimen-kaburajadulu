{% extends 'base.html' %}

{% block styles %}
{# Tidak ada gaya spesifik halaman yang perlu didefinisikan di sini jika semua di style.css #}
{% endblock %}

{% block content %}
<div class="container-fluid d-flex justify-content-center align-items-center page-container"> {# page-container dan justify-content-center sudah ada #}
    <div class="content-wrapper content-wrapper-wide"> {# content-wrapper-wide untuk lebar yang lebih besar #}
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb"> {# Mengandalkan styling .breadcrumb di style.css. Kelas Bootstrap 'bg-white shadow-sm rounded-pill px-4 py-2 mb-4' dihapus. #}
                <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}" class="breadcrumb-dashboard-link"><i class="fas fa-home"></i> Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Preprocessing</li>
            </ol>
        </nav>

        <h2 class="mt-3 mb-3 text-center font-weight-bold">
            <i class="text-primary mr-2"></i>Preprocessing Data
        </h2>
        <p class="mb-4 text-center text-secondary lead">
            <i class="fas fa-broom mr-1 text-info"></i>
            Lakukan pembersihan dan transformasi data teks sebelum proses pelabelan dan klasifikasi.
        </p>

        <form id="preprocessingForm" action="{{ url_for('preprocessing.run_preprocessing_pipeline') }}" method="post" class="text-center mb-4">
            <div id="submitButtonContainer">
                {# Menggunakan btn-custom untuk konsistensi. Kelas Bootstrap 'btn-primary btn-lg px-5' dihapus. #}
                <button type="submit" class="btn btn-custom" id="submitButton">
                    <span class="normal-text">
                        <i class="fas fa-cogs mr-2"></i>Jalankan Preprocessing
                    </span>
                    <span class="loading-text d-none">
                        <span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
                        Sedang memproses...
                    </span>
                </button>
            </div>
            {# Loading spinner ini tidak lagi dibutuhkan karena ada loading-overlay #}
            {#
            <div id="loadingSpinner" class="text-center d-none">
                <div class="spinner-border text-primary spinner-lg" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <div class="mt-2 font-weight-bold text-primary">Memproses data, mohon tunggu...</div>
            </div>
            #}
        </form>

        <div id="loadingOverlay" class="loading-overlay d-none">
            <div class="loading-content">
                <div class="spinner-border text-info mb-3 spinner-lg" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
                <h5 class="mb-2">Sedang Memproses</h5>
                <p class="mb-0 text-muted">Mohon tunggu, sedang melakukan preprocessing data...</p>
            </div>
        </div>

        {# Modal "Tidak Ada Dataset Sumber" #}
        <div class="modal fade" id="noDatasetModal" tabindex="-1" aria-labelledby="noDatasetModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    {# Menggunakan modal-header.warning-header. Kelas Bootstrap 'bg-warning text-dark' dihapus. #}
                    <div class="modal-header warning-header">
                        <h5 class="modal-title" id="noDatasetModalLabel">Tidak Ada Dataset Sumber</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body text-center">
                        Belum ada dataset yang diupload. Silakan upload dataset terlebih dahulu sebelum  preprocessing.<br>
                        <a href="{{ url_for('dataset.input_data') }}" class="btn btn-link font-weight-bold mt-2">Upload Dataset Sekarang</a>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        {# Modal "Tidak Ada Data Preprocessing untuk Dihapus" #}
        <div class="modal fade" id="noPreprocessingToDeleteModal" tabindex="-1" aria-labelledby="noPreprocessingToDeleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    {# Menggunakan modal-header.warning-header. Kelas Bootstrap 'bg-warning text-dark' dihapus. #}
                    <div class="modal-header warning-header">
                        <h5 class="modal-title" id="noPreprocessingToDeleteModalLabel">Tidak Ada Data Preprocessing</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body text-center">
                        Belum ada data hasil preprocessing yang tersedia untuk dihapus.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="deletePreprocessingModal" tabindex="-1" aria-labelledby="deletePreprocessingModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header danger-header">
                        <h5 class="modal-title" id="deletePreprocessingModalLabel">Konfirmasi Hapus Data Preprocessing</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x text-danger mb-3"></i>
                        <p class="mb-0">Apakah Anda yakin ingin <b>menghapus semua data hasil preprocessing</b>?<br>Data yang sudah dihapus <b>tidak dapat dikembalikan</b>.</p>
                    </div>
                    <div class="modal-footer">
                        <form action="{{ url_for('preprocessing.delete_all_preprocessing_data') }}" method="post" class="w-100 text-right">
                            <button type="button" class="btn btn-secondary mr-2" data-dismiss="modal">Batal</button>
                            <button type="submit" class="btn btn-danger">Ya, Hapus Semua</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        {# Alert info, menggunakan alert-custom-info dan alert-maxwidth. Kelas Bootstrap 'shadow-sm' dihapus. #}
        <div class="alert alert-custom-info text-center mb-4 alert-maxwidth" role="alert">
            Total dataset mentah (sumber): <b>{{ total_dataset_source|default(0) }}</b> data.<br>
            Data hasil preprocessing akan muncul di tabel di bawah ini setelah Anda menjalankan proses.
        </div>

        <div class="row justify-content-center mb-4">
            <div class="col-md-6 col-lg-5">
                {# Menggunakan custom-card. Kelas Bootstrap 'shadow-lg mb-4' dihapus. #}
                <div class="custom-card text-center"> 
                    <div class="card-body">
                        <h4 class="card-title font-weight-bold text-primary">Total Data Hasil Preprocessing</h4>
                        {# Menggunakan total-data-highlight. Kelas Bootstrap 'display-4 font-weight-bold text-dark mb-2' dihapus. #}
                        <div class="total-data-highlight">{{ data.total if data and data.total is not none else '0' }}</div>
                        <div class="text-secondary small">Jumlah Data di Tabel Ini</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex flex-wrap flex-md-nowrap justify-content-between align-items-center mb-3 dataset-controls">
            <div class="d-flex flex-wrap align-items-center mb-2 mb-md-0">
                <form action="{{ url_for('preprocessing.show_preprocessing_results') }}" method="GET" class="form-inline search-controls mr-2">
                    <input type="text" name="search" value="{{ search_query|default('') }}" class="form-control mr-2 search-input" placeholder="Cari data...">
                    <button type="submit" class="btn btn-custom">Cari</button>
                    {% if search_query %}
                    <a href="{{ url_for('preprocessing.show_preprocessing_results') }}" class="btn btn-secondary ml-2">Reset Filter</a>
                    {% endif %}
                </form>
            </div>
            <form action="{{ url_for('preprocessing.show_preprocessing_results') }}" method="GET" class="form-inline per-page-control">
                {% if search_query %}<input type="hidden" name="search" value="{{ search_query }}">{% endif %}
                <label for="per_page" class="mr-2 font-weight-bold">Tampilkan</label>
                <select name="per_page" id="per_page" onchange="this.form.submit()" class="form-control">
                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                </select>
            </form>
        </div>

        

        <div class="text-right mb-3">
    {% if data and data.total > 0 %}
        <a href="{{ url_for('preprocessing.download_preprocessing_csv') }}" class="btn btn-success mr-2">
            <i class="fas fa-file-csv"></i> Download CSV
        </a>
        <a href="{{ url_for('preprocessing.download_preprocessing_excel') }}" class="btn btn-success mr-2">
            <i class="fas fa-file-excel"></i> Download Excel
        </a>
        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#deletePreprocessingModal">
            <i class="fas fa-trash-alt"></i> Hapus Data Preprocessing
        </button>
    {% else %}
        <button type="button" class="btn btn-success mr-2" disabled title="Tidak ada data preprocessing untuk diunduh">
            <i class="fas fa-file-csv"></i> Download CSV
        </button>
        <button type="button" class="btn btn-success mr-2" disabled title="Tidak ada data preprocessing untuk diunduh">
            <i class="fas fa-file-excel"></i> Download Excel
        </button>
        <button type="button" class="btn btn-danger" disabled title="Tidak ada data preprocessing untuk dihapus">
            <i class="fas fa-trash-alt"></i> Hapus Data Preprocessing
        </button>
    {% endif %}
</div>
        
        <h4 class="mt-4 mb-2 text-center">Tabel hasil preprocessing</h4>
        <div class="table-scroll-container"> 
            {# Mengganti dataset-table dan classification-table dengan preprocessing-table #}
            <table class="table table-striped table-hover table-bordered text-center preprocessing-table mb-0">
                <thead> {# Mengandalkan styling preprocessing-table thead di style.css. Kelas Bootstrap 'thead-info bg-primary text-white' dihapus. #}
                    <tr>
                        <th class="text-center">ID</th>
                        <th class="text-center">Username</th>
                        <th class="text-center">Full Text</th>
                        <th class="text-center">Text Clean</th>
                        <th class="text-center">Text Normal</th>
                        <th class="text-center">Text Stopwords</th>
                        <th class="text-center">Text Stemmed</th>
                    </tr>
                </thead>
                <tbody>
                    {% if data and data.items %}
                        {% for row in data.items %}
                            <tr>
                                <td class="text-center">{{ row.id }}</td>
                                <td class="text-center">{{ row.username if row.username else '-' }}</td>
                                <td class="text-data text-column">{{ row.full_text if row.full_text else '-' }}</td>
                                <td class="text-data text-column">{{ row.text_clean if row.text_clean else '-' }}</td>
                                <td class="text-data text-column">{{ row.text_baku if row.text_baku else '-' }}</td>
                                <td class="text-data text-column">{{ row.text_stopwords if row.text_stopwords else '-' }}</td>
                                <td class="text-data text-column">{{ row.text_stem if row.text_stem else '-' }}</td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="7" class="text-center text-muted py-4">Tidak ada data untuk ditampilkan.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        {% if data and data.pages > 1 %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mt-4">
                {% if data.has_prev %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('preprocessing.show_preprocessing_results', page=data.prev_num, per_page=per_page, search=search_query) }}">&laquo;</a></li>
                {% else %}<li class="page-item disabled"><span class="page-link">&laquo;</span></li>{% endif %}
                
                {% for page_num_iter in data.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num_iter %}
                        {% if data.page == page_num_iter %}<li class="page-item active"><span class="page-link">{{ page_num_iter }}</span></li>
                        {% else %}<li class="page-item"><a class="page-link" href="{{ url_for('preprocessing.show_preprocessing_results', page=page_num_iter, per_page=per_page, search=search_query) }}">{{ page_num_iter }}</a></li>{% endif %}
                    {% else %}<li class="page-item disabled"><span class="page-link">...</span></li>{% endif %}
                {% endfor %}

                {% if data.has_next %}
                    <li class="page-item"><a class="page-link" href="{{ url_for('preprocessing.show_preprocessing_results', page=data.next_num, per_page=per_page, search=search_query) }}">&raquo;</a></li>
                {% else %}<li class="page-item disabled"><span class="page-link">&raquo;</span></li>{% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var preprocessingForm = document.getElementById('preprocessingForm');
    var submitButton = document.getElementById('submitButton');
    var loadingOverlay = document.getElementById('loadingOverlay');
    {# var loadingSpinner = document.getElementById('loadingSpinner'); // Dihapus dari HTML #}
    var submitButtonContainer = document.getElementById('submitButtonContainer');
    // FIX: Menggunakan ternary operator untuk kompatibilitas yang lebih luas
    var normalText = submitButton ? submitButton.querySelector('.normal-text') : null;
    var loadingText = submitButton ? submitButton.querySelector('.loading-text') : null;

    function disableInteraction() {
        // Add loading class to body to prevent scrolling
        document.body.classList.add('loading');
        
        // Disable all interactive elements
        var buttons = document.querySelectorAll('button, a, input, select');
        buttons.forEach(function(button) {
            button.setAttribute('disabled', 'disabled');
            if (button.tagName === 'A') {
                button.style.pointerEvents = 'none';
            }
        });
    }

    if (preprocessingForm) {
        preprocessingForm.addEventListener('submit', function(e) {
            var totalDataset = parseInt(JSON.parse('{{ total_dataset_source|default(0)|tojson|safe }}'));
            if (totalDataset === 0) {
                e.preventDefault();
                $('#noDatasetModal').modal('show');
                return false;
            }

            // Disable all interaction
            disableInteraction();

            // Disable the button and show loading state
            if (submitButton) {
                submitButton.disabled = true;
                if (normalText) normalText.classList.add('d-none');
                if (loadingText) loadingText.classList.remove('d-none');
            }
            
            // Show loading overlay
            if (loadingOverlay) {
                loadingOverlay.classList.remove('d-none');
            }
            
            // Hide submit button container and show spinner (spinner dihilangkan dari HTML)
            if (submitButtonContainer) submitButtonContainer.classList.add('d-none');
            // if (loadingSpinner) loadingSpinner.classList.remove('d-none'); // Dihapus dari HTML

            // Add event listener to prevent clicks on overlay
            if (loadingOverlay) {
                loadingOverlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                });
            }
        });
    }
});
</script>
{% endblock %}